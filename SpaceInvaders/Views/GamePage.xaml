<Page x:Class="SpaceInvaders.Views.GamePage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:converters="using:SpaceInvaders.Views.Converters"
      xmlns:views="clr-namespace:SpaceInvaders.Views"
      Background="#000000"
      Loaded="Page_Loaded"
      Unloaded="Page_Unloaded"
      KeyDown="Page_KeyDown"
      IsTabStop="True">

    <Page.Resources>
        <converters:ScoreConverter x:Key="ScoreConverter" />
        <converters:LivesConverter x:Key="LivesConverter" />
        <converters:LevelConverter x:Key="LevelConverter" />
        <converters:FinalScoreConverter x:Key="FinalScoreConverter" />
        <views:EnemyTypeToImageConverter x:Key="EnemyTypeToImageConverter"/>
        <views:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <views:PauseButtonTextConverter x:Key="PauseButtonTextConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Page.Resources>

    <Grid>
        <!-- CAMADA 1: Jogo -->
        <Canvas x:Name="GameCanvas">
            <Canvas.Background>
                <!-- use a imagem se quiser (opcional) -->
                <ImageBrush ImageSource="ms-appx:///Assets/Images/background.jpg"
                            Stretch="UniformToFill"/>
            </Canvas.Background>

            <!-- Player -->
            <Image x:Name="PlayerImage"
                   Source="ms-appx:///Assets/Images/player.png"
                   Width="50" Height="30"
                   Canvas.Left="{Binding GameState.Player.Bounds.Left}"
                   Canvas.Top="{Binding GameState.Player.Bounds.Top}"
                   Visibility="Visible"/>

            <!-- Enemies -->
            <ItemsControl ItemsSource="{Binding GameState.Enemies}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Image Width="30" Height="30"
                               Canvas.Left="{Binding Bounds.Left}"
                               Canvas.Top="{Binding Bounds.Top}">
                            <Image.Source>
                                <Binding Path="Type"
                                         Converter="{StaticResource EnemyTypeToImageConverter}"/>
                            </Image.Source>
                        </Image>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Red Enemy (nave bônus) -->
            <Image Source="ms-appx:///Assets/Images/invaderRED.gif"
                   Width="40" Height="30"
                   Canvas.Left="{Binding GameState.RedEnemy.Bounds.Left}"
                   Canvas.Top="{Binding GameState.RedEnemy.Bounds.Top}"
                   Visibility="{Binding GameState.RedEnemy, Converter={StaticResource NullToVisibilityConverter}}"/>

            <!-- Bullets -->
            <ItemsControl ItemsSource="{Binding GameState.Bullets}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Rectangle Width="3" Height="10" Fill="#FFFFFF"
                                   Canvas.Left="{Binding Bounds.Left}"
                                   Canvas.Top="{Binding Bounds.Top}"/>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Shields -->
            <ItemsControl ItemsSource="{Binding GameState.Shields}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Rectangle Width="60" Height="40"
                                   Canvas.Left="{Binding Bounds.Left}"
                                   Canvas.Top="{Binding Bounds.Top}"
                                   Fill="#008000"
                                   Visibility="{Binding IsActive, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Canvas>

        <!-- CAMADA 2: HUD Topo (centralizado) -->
        <StackPanel Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Top"
                    Margin="0,10,0,0"
                    Spacing="24">
            <TextBlock Text="{Binding GameState.Player.Score, Converter={StaticResource ScoreConverter}}"
                       Foreground="#FFFFFF" FontSize="18" FontWeight="Bold"/>
            <TextBlock Text="{Binding GameState.Player.Lives, Converter={StaticResource LivesConverter}}"
                       Foreground="#FFFFFF" FontSize="18" FontWeight="Bold"/>
            <TextBlock Text="{Binding GameState.Level, Converter={StaticResource LevelConverter}}"
                       Foreground="#FFFFFF" FontSize="18" FontWeight="Bold"/>
        </StackPanel>

        <!-- CAMADA 3: Overlay de Pause -->
        <Border Background="#80000000"
                Visibility="{Binding GameState.IsPaused, Converter={StaticResource BooleanToVisibilityConverter}}">
            <TextBlock Text="JOGO PAUSADO"
                       Foreground="#FFFFFF" FontSize="36"
                       HorizontalAlignment="Center" VerticalAlignment="Center"
                       FontWeight="Bold"/>
        </Border>

        <!-- CAMADA 4: Overlay de Game Over -->
        <Border Background="#80000000"
                Visibility="{Binding GameState.IsGameOver, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="20">
                <TextBlock Text="GAME OVER" Foreground="#FF4D4D"
                           FontSize="36" HorizontalAlignment="Center"
                           FontWeight="Bold"/>
                <TextBlock Text="{Binding GameState.Player.Score, Converter={StaticResource FinalScoreConverter}}"
                           Foreground="#FFFFFF" FontSize="22" HorizontalAlignment="Center"/>
                <Button Content="Voltar ao Menu" Command="{Binding MainMenuCommand}"
                        Width="220" Height="44" HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- CAMADA 5: Botões -->
        <StackPanel VerticalAlignment="Bottom" HorizontalAlignment="Right"
                    Margin="16" Spacing="12">
            <Button MinWidth="160" Height="40" Padding="12,6"
                    Content="{Binding GameState.IsPaused, Converter={StaticResource PauseButtonTextConverter}}"
                    Command="{Binding PauseCommand}"/>
            <Button MinWidth="160" Height="40" Padding="12,6"
                    Content="Menu Principal"
                    Command="{Binding MainMenuCommand}"/>
        </StackPanel>
    </Grid>
</Page>
